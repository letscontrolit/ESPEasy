var isSame;!function(anyword){"object"==typeof exports&&"object"==typeof module?anyword(require("codemirror")):"function"==typeof define&&define.amd?define(["codemirror"],mod):anyword(CodeMirror)}((function(CodeMirror){"use strict";var WORD=/[\w?#.,%]+/,RANGE=500;CodeMirror.registerHelper("hint","anyword",(function(editor,options){for(var word=options&&options.word||WORD,range=options&&options.range||500,extraWords=options&&options.extraWords||EXTRAWORDS,cur=editor.getCursor(),curLine=editor.getLine(cur.line),end=cur.ch,start=end;start&&word.test(curLine.charAt(start-1));)--start;var curWord=start!=end&&curLine.slice(start,end);curWord&&(curWord=curWord.toLowerCase()),isSame=extraWords.some(element=>element.toLowerCase()===curWord);for(var list=options&&options.list||[],seen={},re=new RegExp(word.source,"g"),dir=-1;dir<=1;dir+=2)for(var line=cur.line,endLine=Math.min(Math.max(line+dir*range,editor.firstLine()),editor.lastLine())+dir;line!=endLine;line+=dir){var text=editor.getLine(line),m,replaceK=(text=(text=text.replace(/\/{2}.*/g,"")).replace(/(=|-|\+|\*|<|>)\d+/g,"")).match(/\w+(?:,(\S+)){2}/);for(replaceK&&(text=text.replace(replaceK[1]," "+replaceK[1]));m=re.exec(text);)line==cur.line&&m[0].toLowerCase()===curWord||curWord&&0!=m[0].toLowerCase().lastIndexOf(curWord,0)||Object.prototype.hasOwnProperty.call(seen,m[0])||(seen[m[0]]=!0,list.push(m[0]))}list.sort(),list.reverse();let tempList=new Map(list.map(s=>[s.toLowerCase(),s]));(list=[...tempList.values()]).sort();var list2=extraWords.filter(el=>el.toLowerCase().startsWith(curWord||""));list2.sort(),list=list.concat(list2);let tempList2=new Map(list.map(s=>[s.toLowerCase(),s]));return(list=[...tempList2.values()]).sort((function(a,b){return a.toLowerCase().localeCompare(b.toLowerCase())})),{list:list,from:CodeMirror.Pos(cur.line,start),to:CodeMirror.Pos(cur.line,end)}}))})),function(showHint){"object"==typeof exports&&"object"==typeof module?showHint(require("codemirror")):"function"==typeof define&&define.amd?define(["codemirror"],mod):showHint(CodeMirror)}((function(CodeMirror){"use strict";var HINT_ELEMENT_CLASS="CodeMirror-hint",ACTIVE_HINT_ELEMENT_CLASS="CodeMirror-hint-active";function Completion(cm,options){if(this.cm=cm,this.options=options,this.widget=null,this.debounce=0,this.tick=0,this.startPos=this.cm.getCursor("start"),this.startLen=this.cm.getLine(this.startPos.line).length-this.cm.getSelection().length,this.options.updateOnCursorActivity){var self=this;cm.on("cursorActivity",this.activityFunc=function(){self.cursorActivity()})}CodeMirror.signal(this,"startCompletion",this)}CodeMirror.showHint=function(cm,getHints,options){if(!getHints)return cm.showHint(options);options&&options.async&&(getHints.async=!0);var newOpts={hint:getHints};if(options)for(var prop in options)newOpts[prop]=options[prop];return cm.showHint(newOpts)},CodeMirror.defineExtension("showHint",(function(options){options=parseOptions(this,this.getCursor("start"),options);var selections=this.listSelections();if(!(selections.length>1)){if(this.somethingSelected()){if(!options.hint.supportsSelection)return;for(var i=0;i<selections.length;i++)if(selections[i].head.line!=selections[i].anchor.line)return}this.state.completionActive&&this.state.completionActive.close();var completion=this.state.completionActive=new Completion(this,options);completion.options.hint&&(CodeMirror.signal(this,"startCompletion",this),completion.update(!0))}})),CodeMirror.defineExtension("closeHint",(function(){this.state.completionActive&&this.state.completionActive.close()}));var requestAnimationFrame=window.requestAnimationFrame||function(fn){return setTimeout(fn,1e3/60)},cancelAnimationFrame=window.cancelAnimationFrame||clearTimeout;function parseOptions(cm,pos,options){var editor=cm.options.hintOptions,out={};for(var prop in defaultOptions)out[prop]=defaultOptions[prop];if(editor)for(var prop in editor)void 0!==editor[prop]&&(out[prop]=editor[prop]);if(options)for(var prop in options)void 0!==options[prop]&&(out[prop]=options[prop]);return out.hint.resolve&&(out.hint=out.hint.resolve(cm,pos)),out}function getText(completion){return"string"==typeof completion?completion:completion.text}function buildKeyMap(completion,handle){var baseMap={Up:function(){handle.moveFocus(-1)},Down:function(){handle.moveFocus(1)},PageUp:function(){handle.moveFocus(1-handle.menuSize(),!0)},PageDown:function(){handle.moveFocus(handle.menuSize()-1,!0)},Home:function(){handle.setFocus(0)},End:function(){handle.setFocus(handle.length-1)},Enter:handle.pick,Tab:handle.pick,Esc:handle.close},mac=/Mac/.test(navigator.platform);isSame&&(baseMap.Space=handle.pick,baseMap[","]=handle.pick),mac&&(baseMap["Ctrl-P"]=function(){handle.moveFocus(-1)},baseMap["Ctrl-N"]=function(){handle.moveFocus(1)});var custom=completion.options.customKeys,ourMap=custom?{}:baseMap;function addBinding(key,val){var bound;bound="string"!=typeof val?function(cm){return val(cm,handle)}:baseMap.hasOwnProperty(val)?baseMap[val]:val,ourMap[key]=bound}if(custom)for(var key in custom)custom.hasOwnProperty(key)&&addBinding(key,custom[key]);var extra=completion.options.extraKeys;if(extra)for(var key in extra)extra.hasOwnProperty(key)&&addBinding(key,extra[key]);return ourMap}function getHintElement(hintsElement,el){for(;el&&el!=hintsElement;){if("LI"===el.nodeName.toUpperCase()&&el.parentNode==hintsElement)return el;el=el.parentNode}}function Widget(completion,data){this.id="cm-complete-"+Math.floor(Math.random(1e6)),this.completion=completion,this.data=data,this.picked=!1;var widget=this,cm=completion.cm,ownerDocument=cm.getInputField().ownerDocument,parentWindow=ownerDocument.defaultView||ownerDocument.parentWindow,hints=this.hints=ownerDocument.createElement("ul");hints.setAttribute("role","listbox"),hints.setAttribute("aria-expanded","true"),hints.id=this.id;var theme=completion.cm.options.theme;hints.className="CodeMirror-hints "+theme,this.selectedHint=data.selectedHint||0;for(var completions=data.list,i=0;i<completions.length;++i){var elt=hints.appendChild(ownerDocument.createElement("li")),cur=completions[i],className="CodeMirror-hint"+(i!=this.selectedHint?"":" CodeMirror-hint-active");null!=cur.className&&(className=cur.className+" "+className),elt.className=className,i==this.selectedHint&&elt.setAttribute("aria-selected","true"),elt.id=this.id+"-"+i,elt.setAttribute("role","option"),cur.render?cur.render(elt,data,cur):elt.appendChild(ownerDocument.createTextNode(cur.displayText||getText(cur))),elt.hintId=i}var container=completion.options.container||ownerDocument.body,pos=cm.cursorCoords(completion.options.alignWithWord?data.from:null),left=pos.left,top=pos.bottom,below=!0,offsetLeft=0,offsetTop=0;if(container!==ownerDocument.body){var isContainerPositioned,offsetParent=-1!==["absolute","relative","fixed"].indexOf(parentWindow.getComputedStyle(container).position)?container:container.offsetParent,offsetParentPosition=offsetParent.getBoundingClientRect(),bodyPosition=ownerDocument.body.getBoundingClientRect();offsetLeft=offsetParentPosition.left-bodyPosition.left-offsetParent.scrollLeft,offsetTop=offsetParentPosition.top-bodyPosition.top-offsetParent.scrollTop}hints.style.left=left-offsetLeft+"px",hints.style.top=top-offsetTop+"px";var winW=parentWindow.innerWidth||Math.max(ownerDocument.body.offsetWidth,ownerDocument.documentElement.offsetWidth),winH=parentWindow.innerHeight||Math.max(ownerDocument.body.offsetHeight,ownerDocument.documentElement.offsetHeight);container.appendChild(hints),cm.getInputField().setAttribute("aria-autocomplete","list"),cm.getInputField().setAttribute("aria-owns",this.id),cm.getInputField().setAttribute("aria-activedescendant",this.id+"-"+this.selectedHint);var box=completion.options.moveOnOverlap?hints.getBoundingClientRect():new DOMRect,scrolls=!!completion.options.paddingForScrollbar&&hints.scrollHeight>hints.clientHeight+1,startScroll,overlapY;if(setTimeout((function(){startScroll=cm.getScrollInfo()})),box.bottom-winH>0){var height=box.bottom-box.top,curTop;if(pos.top-(pos.bottom-box.top)-height>0)hints.style.top=(top=pos.top-height-offsetTop)+"px",below=!1;else if(height>winH){hints.style.height=winH-5+"px",hints.style.top=(top=pos.bottom-box.top-offsetTop)+"px";var cursor=cm.getCursor();data.from.ch!=cursor.ch&&(pos=cm.cursorCoords(cursor),hints.style.left=(left=pos.left-offsetLeft)+"px",box=hints.getBoundingClientRect())}}var overlapX=box.right-winW,closingOnBlur;if(scrolls&&(overlapX+=cm.display.nativeBarWidth),overlapX>0&&(box.right-box.left>winW&&(hints.style.width=winW-5+"px",overlapX-=box.right-box.left-winW),hints.style.left=(left=pos.left-overlapX-offsetLeft)+"px"),scrolls)for(var node=hints.firstChild;node;node=node.nextSibling)node.style.paddingRight=cm.display.nativeBarWidth+"px";(cm.addKeyMap(this.keyMap=buildKeyMap(completion,{moveFocus:function(n,avoidWrap){widget.changeActive(widget.selectedHint+n,avoidWrap)},setFocus:function(n){widget.changeActive(n)},menuSize:function(){return widget.screenAmount()},length:completions.length,close:function(){completion.close()},pick:function(){widget.pick()},data:data})),completion.options.closeOnUnfocus)&&(cm.on("blur",this.onBlur=function(){closingOnBlur=setTimeout((function(){completion.close()}),100)}),cm.on("focus",this.onFocus=function(){clearTimeout(closingOnBlur)}));cm.on("scroll",this.onScroll=function(){var curScroll=cm.getScrollInfo(),editor=cm.getWrapperElement().getBoundingClientRect();startScroll||(startScroll=cm.getScrollInfo());var newTop=top+startScroll.top-curScroll.top,point=newTop-(parentWindow.pageYOffset||(ownerDocument.documentElement||ownerDocument.body).scrollTop);if(below||(point+=hints.offsetHeight),point<=editor.top||point>=editor.bottom)return completion.close();hints.style.top=newTop+"px",hints.style.left=left+startScroll.left-curScroll.left+"px"}),CodeMirror.on(hints,"dblclick",(function(e){var t=getHintElement(hints,e.target||e.srcElement);t&&null!=t.hintId&&(widget.changeActive(t.hintId),widget.pick())})),CodeMirror.on(hints,"click",(function(e){var t=getHintElement(hints,e.target||e.srcElement);t&&null!=t.hintId&&(widget.changeActive(t.hintId),completion.options.completeOnSingleClick&&widget.pick())})),CodeMirror.on(hints,"mousedown",(function(){setTimeout((function(){cm.focus()}),20)}));var selectedHintRange=this.getSelectedHintRange();return 0===selectedHintRange.from&&0===selectedHintRange.to||this.scrollToActive(),CodeMirror.signal(data,"select",completions[this.selectedHint],hints.childNodes[this.selectedHint]),!0}function applicableHelpers(cm,helpers){if(!cm.somethingSelected())return helpers;for(var result=[],i=0;i<helpers.length;i++)helpers[i].supportsSelection&&result.push(helpers[i]);return result}function fetchHints(hint,cm,options,callback){if(hint.async)hint(cm,callback,options);else{var result=hint(cm,options);result&&result.then?result.then(callback):callback(result)}}function resolveAutoHints(cm,pos){var helpers=cm.getHelpers(pos,"hint"),words;if(helpers.length){var resolved=function(cm,callback,options){var app=applicableHelpers(cm,helpers);function run(i){if(i==app.length)return callback(null);fetchHints(app[i],cm,options,(function(result){result&&result.list.length>0?callback(result):run(i+1)}))}run(0)};return resolved.async=!0,resolved.supportsSelection=!0,resolved}return(words=cm.getHelper(cm.getCursor(),"hintWords"))?function(cm){return CodeMirror.hint.fromList(cm,{words:words})}:CodeMirror.hint.anyword?function(cm,options){return CodeMirror.hint.anyword(cm,options)}:function(){}}Completion.prototype={close:function(){this.active()&&(this.cm.state.completionActive=null,this.tick=null,this.options.updateOnCursorActivity&&this.cm.off("cursorActivity",this.activityFunc),this.widget&&this.data&&CodeMirror.signal(this.data,"close"),this.widget&&this.widget.close(),CodeMirror.signal(this.cm,"endCompletion",this.cm))},active:function(){return this.cm.state.completionActive==this},pick:function(data,i){var completion=data.list[i],self=this;this.cm.operation((function(){completion.hint?completion.hint(self.cm,data,completion):self.cm.replaceRange(getText(completion),completion.from||data.from,completion.to||data.to,"complete"),CodeMirror.signal(data,"pick",completion),self.cm.scrollIntoView()})),this.options.closeOnPick&&this.close()},cursorActivity:function(){this.debounce&&(cancelAnimationFrame(this.debounce),this.debounce=0);var identStart=this.startPos;this.data&&(identStart=this.data.from);var pos=this.cm.getCursor(),line=this.cm.getLine(pos.line);if(pos.line!=this.startPos.line||line.length-pos.ch!=this.startLen-this.startPos.ch||pos.ch<identStart.ch||this.cm.somethingSelected()||!pos.ch||this.options.closeCharacters.test(line.charAt(pos.ch-1)))this.close();else{var self=this;this.debounce=requestAnimationFrame((function(){self.update()})),this.widget&&this.widget.disable()}},update:function(first){if(null!=this.tick){var self=this,myTick=++this.tick;fetchHints(this.options.hint,this.cm,this.options,(function(data){self.tick==myTick&&self.finishUpdate(data,first)}))}},finishUpdate:function(data,first){this.data&&CodeMirror.signal(this.data,"update");var picked=this.widget&&this.widget.picked||first&&this.options.completeSingle;this.widget&&this.widget.close(),this.data=data,data&&data.list.length&&(picked&&1==data.list.length?this.pick(data,0):(this.widget=new Widget(this,data),CodeMirror.signal(data,"shown")))}},Widget.prototype={close:function(){if(this.completion.widget==this){this.completion.widget=null,this.hints.parentNode&&this.hints.parentNode.removeChild(this.hints),this.completion.cm.removeKeyMap(this.keyMap);var input=this.completion.cm.getInputField();input.removeAttribute("aria-activedescendant"),input.removeAttribute("aria-owns");var cm=this.completion.cm;this.completion.options.closeOnUnfocus&&(cm.off("blur",this.onBlur),cm.off("focus",this.onFocus)),cm.off("scroll",this.onScroll)}},disable:function(){this.completion.cm.removeKeyMap(this.keyMap);var widget=this;this.keyMap={Enter:function(){widget.picked=!0}},this.completion.cm.addKeyMap(this.keyMap)},pick:function(){var whatisIt,Xspace,Xspace2,numCharA,numCharB;numCharA=rEdit.getCursor().ch,numCharB=rEdit.getCursor().ch-this.data.list[0].length,1===numCharA||0===numCharA?Xspace="":(Xspace=" ".repeat(numCharA-2),Xspace2=numCharB>0?" ".repeat(numCharB):""),isSame&&"Space"===nameKey?"If"===this.data.list[0]?this.data.list[0]=this.data.list[0]+" ":"Do"!=this.data.list[0]&&(this.data.list[0]=this.data.list[0]+" ",isSame=!1,whatisIt=0):isSame&&"Enter"===nameKey?("If"===this.data.list[0]?(this.data.list[0]=this.data.list[0]+" \n"+Xspace+"Endif",whatisIt=1):"On"===this.data.list[0]?(this.data.list[0]=this.data.list[0]+"  Do\n\nEndon",whatisIt=2):"Do"===this.data.list[0]?(this.data.list[0]=this.data.list[0]+"\n\nEndon",whatisIt=2.2):(this.data.list[0]=this.data.list[0]+"\n"+Xspace2,whatisIt=0),isSame=!1):isSame&&","===nameKey&&(this.data.list[0]=this.data.list[0]+",",whatisIt=0,isSame=!1),"LogEntry"===this.data.list[this.selectedHint]&&(this.data.list[this.selectedHint]=this.data.list[this.selectedHint]+",''",whatisIt=3),this.completion.pick(this.data,this.selectedHint);var numLine=rEdit.getCursor().line,numChar=rEdit.getCursor().ch;if(1===whatisIt)rEdit.setCursor({line:numLine-1});else if(2===whatisIt)for(rEdit.setCursor({line:numLine-1}),rEdit.execCommand("insertSoftTab"),rEdit.setCursor({line:numLine-2,ch:numCharA+1});rEdit.getCursor().ch>3;)rEdit.execCommand("indentLess");else 2.2===whatisIt?(rEdit.setCursor({line:numLine-1}),rEdit.execCommand("insertSoftTab")):3===whatisIt&&rEdit.setCursor({line:numLine,ch:numChar-1})},changeActive:function(i,avoidWrap){if(i>=this.data.list.length?i=avoidWrap?this.data.list.length-1:0:i<0&&(i=avoidWrap?0:this.data.list.length-1),this.selectedHint!=i){var node=this.hints.childNodes[this.selectedHint];node&&(node.className=node.className.replace(" CodeMirror-hint-active",""),node.removeAttribute("aria-selected")),(node=this.hints.childNodes[this.selectedHint=i]).className+=" CodeMirror-hint-active",node.setAttribute("aria-selected","true"),this.completion.cm.getInputField().setAttribute("aria-activedescendant",node.id),this.scrollToActive(),CodeMirror.signal(this.data,"select",this.data.list[this.selectedHint],node)}},scrollToActive:function(){var selectedHintRange=this.getSelectedHintRange(),node1=this.hints.childNodes[selectedHintRange.from],node2=this.hints.childNodes[selectedHintRange.to],firstNode=this.hints.firstChild;node1.offsetTop<this.hints.scrollTop?this.hints.scrollTop=node1.offsetTop-firstNode.offsetTop:node2.offsetTop+node2.offsetHeight>this.hints.scrollTop+this.hints.clientHeight&&(this.hints.scrollTop=node2.offsetTop+node2.offsetHeight-this.hints.clientHeight+firstNode.offsetTop)},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1},getSelectedHintRange:function(){var margin=this.completion.options.scrollMargin||0;return{from:Math.max(0,this.selectedHint-margin),to:Math.min(this.data.list.length-1,this.selectedHint+margin)}}},CodeMirror.registerHelper("hint","auto",{resolve:resolveAutoHints}),CodeMirror.registerHelper("hint","fromList",(function(cm,options){var cur=cm.getCursor(),token=cm.getTokenAt(cur),term,from=CodeMirror.Pos(cur.line,token.start),to=cur;token.start<cur.ch&&/\w/.test(token.string.charAt(cur.ch-token.start-1))?term=token.string.substr(0,cur.ch-token.start):(term="",from=cur);for(var found=[],i=0;i<options.words.length;i++){var word=options.words[i];word.slice(0,term.length)==term&&found.push(word)}if(found.length)return{list:found,from:from,to:to}})),CodeMirror.commands.autocomplete=CodeMirror.showHint;var defaultOptions={hint:CodeMirror.hint.auto,completeSingle:!0,alignWithWord:!0,closeCharacters:/[[\s=+*\-()\[\]{};:>]/,closeOnPick:!0,closeOnUnfocus:!0,updateOnCursorActivity:!0,completeOnSingleClick:!0,container:null,customKeys:null,extraKeys:null,paddingForScrollbar:!0,moveOnOverlap:!0};CodeMirror.defineOption("hintOptions",null)})),function(search){"object"==typeof exports&&"object"==typeof module?search(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],mod):search(CodeMirror)}((function(CodeMirror){"use strict";function searchOverlay(query,caseInsensitive){return"string"==typeof query?query=new RegExp(query.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),caseInsensitive?"gi":"g"):query.global||(query=new RegExp(query.source,query.ignoreCase?"gi":"g")),{token:function(stream){query.lastIndex=stream.pos;var match=query.exec(stream.string);if(match&&match.index==stream.pos)return stream.pos+=match[0].length||1,"searching";match?stream.pos=match.index:stream.skipToEnd()}}}function SearchState(){this.posFrom=this.posTo=this.lastQuery=this.query=null,this.overlay=null}function getSearchState(cm){return cm.state.search||(cm.state.search=new SearchState)}function queryCaseInsensitive(query){return"string"==typeof query&&query==query.toLowerCase()}function getSearchCursor(cm,query,pos){return cm.getSearchCursor(query,pos,{caseFold:queryCaseInsensitive(query),multiline:!0})}function persistentDialog(cm,text,deflt,onEnter,onKeyDown){cm.openDialog(text,onEnter,{value:deflt,selectValueOnOpen:!0,closeOnEnter:!1,onClose:function(){clearSearch(cm)},onKeyDown:onKeyDown,bottom:cm.options.search.bottom})}function dialog(cm,text,shortText,deflt,f){cm.openDialog?cm.openDialog(text,f,{value:deflt,selectValueOnOpen:!0,bottom:cm.options.search.bottom}):f(prompt(shortText,deflt))}function confirmDialog(cm,text,shortText,fs){cm.openConfirm?cm.openConfirm(text,fs):confirm(shortText)&&fs[0]()}function parseString(string){return string.replace(/\\([nrt\\])/g,(function(match,ch){return"n"==ch?"\n":"r"==ch?"\r":"t"==ch?"\t":"\\"==ch?"\\":match}))}function parseQuery(query){var isRE=query.match(/^\/(.*)\/([a-z]*)$/);if(isRE)try{query=new RegExp(isRE[1],-1==isRE[2].indexOf("i")?"":"i")}catch(e){}else query=parseString(query);return("string"==typeof query?""==query:query.test(""))&&(query=/x^/),query}function startSearch(cm,state,query){state.queryText=query,state.query=parseQuery(query),cm.removeOverlay(state.overlay,queryCaseInsensitive(state.query)),state.overlay=searchOverlay(state.query,queryCaseInsensitive(state.query)),cm.addOverlay(state.overlay),cm.showMatchesOnScrollbar&&(state.annotate&&(state.annotate.clear(),state.annotate=null),state.annotate=cm.showMatchesOnScrollbar(state.query,queryCaseInsensitive(state.query)))}function doSearch(cm,rev,persistent,immediate){var state=getSearchState(cm);if(state.query)return findNext(cm,rev);var q=cm.getSelection()||state.lastQuery;if(q instanceof RegExp&&"x^"==q.source&&(q=null),persistent&&cm.openDialog){var hiding=null,searchNext=function(query,event){CodeMirror.e_stop(event),query&&(query!=state.queryText&&(startSearch(cm,state,query),state.posFrom=state.posTo=cm.getCursor()),hiding&&(hiding.style.opacity=1),findNext(cm,event.shiftKey,(function(_,to){var dialog;to.line<3&&document.querySelector&&(dialog=cm.display.wrapper.querySelector(".CodeMirror-dialog"))&&dialog.getBoundingClientRect().bottom-4>cm.cursorCoords(to,"window").top&&((hiding=dialog).style.opacity=.4)})))};persistentDialog(cm,getQueryDialog(cm),q,searchNext,(function(event,query){var keyName=CodeMirror.keyName(event),extra=cm.getOption("extraKeys"),cmd=extra&&extra[keyName]||CodeMirror.keyMap[cm.getOption("keyMap")][keyName];"findNext"==cmd||"findPrev"==cmd||"findPersistentNext"==cmd||"findPersistentPrev"==cmd?(CodeMirror.e_stop(event),startSearch(cm,getSearchState(cm),query),cm.execCommand(cmd)):"find"!=cmd&&"findPersistent"!=cmd||(CodeMirror.e_stop(event),searchNext(query,event))})),immediate&&q&&(startSearch(cm,state,q),findNext(cm,rev))}else dialog(cm,getQueryDialog(cm),"Search for:",q,(function(query){query&&!state.query&&cm.operation((function(){startSearch(cm,state,query),state.posFrom=state.posTo=cm.getCursor(),findNext(cm,rev)}))}))}function findNext(cm,rev,callback){cm.operation((function(){var state=getSearchState(cm),cursor=getSearchCursor(cm,state.query,rev?state.posFrom:state.posTo);(cursor.find(rev)||(cursor=getSearchCursor(cm,state.query,rev?CodeMirror.Pos(cm.lastLine()):CodeMirror.Pos(cm.firstLine(),0))).find(rev))&&(cm.setSelection(cursor.from(),cursor.to()),cm.scrollIntoView({from:cursor.from(),to:cursor.to()},20),state.posFrom=cursor.from(),state.posTo=cursor.to(),callback&&callback(cursor.from(),cursor.to()))}))}function clearSearch(cm){cm.operation((function(){var state=getSearchState(cm);state.lastQuery=state.query,state.query&&(state.query=state.queryText=null,cm.removeOverlay(state.overlay),state.annotate&&(state.annotate.clear(),state.annotate=null))}))}function el(tag,attrs){var element=tag?document.createElement(tag):document.createDocumentFragment();for(var key in attrs)element[key]=attrs[key];for(var i=2;i<arguments.length;i++){var child=arguments[i];element.appendChild("string"==typeof child?document.createTextNode(child):child)}return element}function getQueryDialog(cm){var label=el("label",{className:"CodeMirror-search-label"},cm.phrase("Search:"),el("input",{type:"text",style:"width: 10em",className:"CodeMirror-search-field",id:"CodeMirror-search-field"}));return label.setAttribute("for","CodeMirror-search-field"),el("",null,label," ",el("span",{style:"color: #666",className:"CodeMirror-search-hint"},cm.phrase("(Use /re/ syntax for regexp search)")))}function getReplaceQueryDialog(cm){return el("",null," ",el("input",{type:"text",style:"width: 10em",className:"CodeMirror-search-field"})," ",el("span",{style:"color: #666",className:"CodeMirror-search-hint"},cm.phrase("(Use /re/ syntax for regexp search)")))}function getReplacementQueryDialog(cm){return el("",null,el("span",{className:"CodeMirror-search-label"},cm.phrase("With:"))," ",el("input",{type:"text",style:"width: 10em",className:"CodeMirror-search-field"}))}function getDoReplaceConfirm(cm){return el("",null,el("span",{className:"CodeMirror-search-label"},cm.phrase("Replace?"))," ",el("button",{},cm.phrase("Yes"))," ",el("button",{},cm.phrase("No"))," ",el("button",{},cm.phrase("All"))," ",el("button",{},cm.phrase("Stop")))}function replaceAll(cm,query,text){cm.operation((function(){for(var cursor=getSearchCursor(cm,query);cursor.findNext();)if("string"!=typeof query){var match=cm.getRange(cursor.from(),cursor.to()).match(query);cursor.replace(text.replace(/\$(\d)/g,(function(_,i){return match[i]})))}else cursor.replace(text)}))}function replace(cm,all){if(!cm.getOption("readOnly")){var query=cm.getSelection()||getSearchState(cm).lastQuery,dialogText=all?cm.phrase("Replace all:"):cm.phrase("Replace:"),fragment=el("",null,el("span",{className:"CodeMirror-search-label"},dialogText),getReplaceQueryDialog(cm));dialog(cm,fragment,dialogText,query,(function(query){query&&(query=parseQuery(query),dialog(cm,getReplacementQueryDialog(cm),cm.phrase("Replace with:"),"",(function(text){if(text=parseString(text),all)replaceAll(cm,query,text);else{clearSearch(cm);var cursor=getSearchCursor(cm,query,cm.getCursor("from")),advance=function(){var start=cursor.from(),match;!(match=cursor.findNext())&&(cursor=getSearchCursor(cm,query),!(match=cursor.findNext())||start&&cursor.from().line==start.line&&cursor.from().ch==start.ch)||(cm.setSelection(cursor.from(),cursor.to()),cm.scrollIntoView({from:cursor.from(),to:cursor.to()}),confirmDialog(cm,getDoReplaceConfirm(cm),cm.phrase("Replace?"),[function(){doReplace(match)},advance,function(){replaceAll(cm,query,text)}]))},doReplace=function(match){cursor.replace("string"==typeof query?text:text.replace(/\$(\d)/g,(function(_,i){return match[i]}))),advance()};advance()}})))}))}}CodeMirror.defineOption("search",{bottom:!1}),CodeMirror.commands.find=function(cm){clearSearch(cm),doSearch(cm)},CodeMirror.commands.findPersistent=function(cm){clearSearch(cm),doSearch(cm,!1,!0)},CodeMirror.commands.findPersistentNext=function(cm){doSearch(cm,!1,!0,!0)},CodeMirror.commands.findPersistentPrev=function(cm){doSearch(cm,!0,!0,!0)},CodeMirror.commands.findNext=doSearch,CodeMirror.commands.findPrev=function(cm){doSearch(cm,!0)},CodeMirror.commands.clearSearch=clearSearch,CodeMirror.commands.replace=replace,CodeMirror.commands.replaceAll=function(cm){replace(cm,!0)}})),function(searchcursor){"object"==typeof exports&&"object"==typeof module?searchcursor(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],mod):searchcursor(CodeMirror)}((function(CodeMirror){"use strict";var Pos=CodeMirror.Pos,doFold,noFold;function regexpFlags(regexp){var flags=regexp.flags;return null!=flags?flags:(regexp.ignoreCase?"i":"")+(regexp.global?"g":"")+(regexp.multiline?"m":"")}function ensureFlags(regexp,flags){for(var current=regexpFlags(regexp),target=current,i=0;i<flags.length;i++)-1==target.indexOf(flags.charAt(i))&&(target+=flags.charAt(i));return current==target?regexp:new RegExp(regexp.source,target)}function maybeMultiline(regexp){return/\\s|\\n|\n|\\W|\\D|\[\^/.test(regexp.source)}function searchRegexpForward(doc,regexp,start){regexp=ensureFlags(regexp,"g");for(var line=start.line,ch=start.ch,last=doc.lastLine();line<=last;line++,ch=0){regexp.lastIndex=ch;var string=doc.getLine(line),match=regexp.exec(string);if(match)return{from:Pos(line,match.index),to:Pos(line,match.index+match[0].length),match:match}}}function searchRegexpForwardMultiline(doc,regexp,start){if(!maybeMultiline(regexp))return searchRegexpForward(doc,regexp,start);regexp=ensureFlags(regexp,"gm");for(var string,chunk=1,line=start.line,last=doc.lastLine();line<=last;){for(var i=0;i<chunk&&!(line>last);i++){var curLine=doc.getLine(line++);string=null==string?curLine:string+"\n"+curLine}chunk*=2,regexp.lastIndex=start.ch;var match=regexp.exec(string);if(match){var before=string.slice(0,match.index).split("\n"),inside=match[0].split("\n"),startLine=start.line+before.length-1,startCh=before[before.length-1].length;return{from:Pos(startLine,startCh),to:Pos(startLine+inside.length-1,1==inside.length?startCh+inside[0].length:inside[inside.length-1].length),match:match}}}}function lastMatchIn(string,regexp,endMargin){for(var match,from=0;from<=string.length;){regexp.lastIndex=from;var newMatch=regexp.exec(string);if(!newMatch)break;var end=newMatch.index+newMatch[0].length;if(end>string.length-endMargin)break;(!match||end>match.index+match[0].length)&&(match=newMatch),from=newMatch.index+1}return match}function searchRegexpBackward(doc,regexp,start){regexp=ensureFlags(regexp,"g");for(var line=start.line,ch=start.ch,first=doc.firstLine();line>=first;line--,ch=-1){var string=doc.getLine(line),match=lastMatchIn(string,regexp,ch<0?0:string.length-ch);if(match)return{from:Pos(line,match.index),to:Pos(line,match.index+match[0].length),match:match}}}function searchRegexpBackwardMultiline(doc,regexp,start){if(!maybeMultiline(regexp))return searchRegexpBackward(doc,regexp,start);regexp=ensureFlags(regexp,"gm");for(var string,chunkSize=1,endMargin=doc.getLine(start.line).length-start.ch,line=start.line,first=doc.firstLine();line>=first;){for(var i=0;i<chunkSize&&line>=first;i++){var curLine=doc.getLine(line--);string=null==string?curLine:curLine+"\n"+string}chunkSize*=2;var match=lastMatchIn(string,regexp,endMargin);if(match){var before=string.slice(0,match.index).split("\n"),inside=match[0].split("\n"),startLine=line+before.length,startCh=before[before.length-1].length;return{from:Pos(startLine,startCh),to:Pos(startLine+inside.length-1,1==inside.length?startCh+inside[0].length:inside[inside.length-1].length),match:match}}}}function adjustPos(orig,folded,pos,foldFunc){if(orig.length==folded.length)return pos;for(var min=0,max=pos+Math.max(0,orig.length-folded.length);;){if(min==max)return min;var mid=min+max>>1,len=foldFunc(orig.slice(0,mid)).length;if(len==pos)return mid;len>pos?max=mid:min=mid+1}}function searchStringForward(doc,query,start,caseFold){if(!query.length)return null;var fold=caseFold?doFold:noFold,lines=fold(query).split(/\r|\n\r?/);search:for(var line=start.line,ch=start.ch,last=doc.lastLine()+1-lines.length;line<=last;line++,ch=0){var orig=doc.getLine(line).slice(ch),string=fold(orig);if(1==lines.length){var found=string.indexOf(lines[0]);if(-1==found)continue search;var start=adjustPos(orig,string,found,fold)+ch;return{from:Pos(line,adjustPos(orig,string,found,fold)+ch),to:Pos(line,adjustPos(orig,string,found+lines[0].length,fold)+ch)}}var cutFrom=string.length-lines[0].length;if(string.slice(cutFrom)==lines[0]){for(var i=1;i<lines.length-1;i++)if(fold(doc.getLine(line+i))!=lines[i])continue search;var end=doc.getLine(line+lines.length-1),endString=fold(end),lastLine=lines[lines.length-1];if(endString.slice(0,lastLine.length)==lastLine)return{from:Pos(line,adjustPos(orig,string,cutFrom,fold)+ch),to:Pos(line+lines.length-1,adjustPos(end,endString,lastLine.length,fold))}}}}function searchStringBackward(doc,query,start,caseFold){if(!query.length)return null;var fold=caseFold?doFold:noFold,lines=fold(query).split(/\r|\n\r?/);search:for(var line=start.line,ch=start.ch,first=doc.firstLine()-1+lines.length;line>=first;line--,ch=-1){var orig=doc.getLine(line);ch>-1&&(orig=orig.slice(0,ch));var string=fold(orig);if(1==lines.length){var found=string.lastIndexOf(lines[0]);if(-1==found)continue search;return{from:Pos(line,adjustPos(orig,string,found,fold)),to:Pos(line,adjustPos(orig,string,found+lines[0].length,fold))}}var lastLine=lines[lines.length-1];if(string.slice(0,lastLine.length)==lastLine){for(var i=1,start=line-lines.length+1;i<lines.length-1;i++)if(fold(doc.getLine(start+i))!=lines[i])continue search;var top=doc.getLine(line+1-lines.length),topString=fold(top);if(topString.slice(topString.length-lines[0].length)==lines[0])return{from:Pos(line+1-lines.length,adjustPos(top,topString,top.length-lines[0].length,fold)),to:Pos(line,adjustPos(orig,string,lastLine.length,fold))}}}}function SearchCursor(doc,query,pos,options){var caseFold;this.atOccurrence=!1,this.afterEmptyMatch=!1,this.doc=doc,pos=pos?doc.clipPos(pos):Pos(0,0),this.pos={from:pos,to:pos},"object"==typeof options?caseFold=options.caseFold:(caseFold=options,options=null),"string"==typeof query?(null==caseFold&&(caseFold=!1),this.matches=function(reverse,pos){return(reverse?searchStringBackward:searchStringForward)(doc,query,pos,caseFold)}):(query=ensureFlags(query,"gm"),options&&!1===options.multiline?this.matches=function(reverse,pos){return(reverse?searchRegexpBackward:searchRegexpForward)(doc,query,pos)}:this.matches=function(reverse,pos){return(reverse?searchRegexpBackwardMultiline:searchRegexpForwardMultiline)(doc,query,pos)})}String.prototype.normalize?(doFold=function(str){return str.normalize("NFD").toLowerCase()},noFold=function(str){return str.normalize("NFD")}):(doFold=function(str){return str.toLowerCase()},noFold=function(str){return str}),SearchCursor.prototype={findNext:function(){return this.find(!1)},findPrevious:function(){return this.find(!0)},find:function(reverse){var head=this.doc.clipPos(reverse?this.pos.from:this.pos.to);if(this.afterEmptyMatch&&this.atOccurrence&&(head=Pos(head.line,head.ch),reverse?(head.ch--,head.ch<0&&(head.line--,head.ch=(this.doc.getLine(head.line)||"").length)):(head.ch++,head.ch>(this.doc.getLine(head.line)||"").length&&(head.ch=0,head.line++)),0!=CodeMirror.cmpPos(head,this.doc.clipPos(head))))return this.atOccurrence=!1;var result=this.matches(reverse,head);if(this.afterEmptyMatch=result&&0==CodeMirror.cmpPos(result.from,result.to),result)return this.pos=result,this.atOccurrence=!0,this.pos.match||!0;var end=Pos(reverse?this.doc.firstLine():this.doc.lastLine()+1,0);return this.pos={from:end,to:end},this.atOccurrence=!1},from:function(){if(this.atOccurrence)return this.pos.from},to:function(){if(this.atOccurrence)return this.pos.to},replace:function(newText,origin){if(this.atOccurrence){var lines=CodeMirror.splitLines(newText);this.doc.replaceRange(lines,this.pos.from,this.pos.to,origin),this.pos.to=Pos(this.pos.from.line+lines.length-1,lines[lines.length-1].length+(1==lines.length?this.pos.from.ch:0))}}},CodeMirror.defineExtension("getSearchCursor",(function(query,pos,caseFold){return new SearchCursor(this.doc,query,pos,caseFold)})),CodeMirror.defineDocExtension("getSearchCursor",(function(query,pos,caseFold){return new SearchCursor(this,query,pos,caseFold)})),CodeMirror.defineExtension("selectMatches",(function(query,caseFold){for(var ranges=[],cur=this.getSearchCursor(query,this.getCursor("from"),caseFold);cur.findNext()&&!(CodeMirror.cmpPos(cur.to(),this.getCursor("to"))>0);)ranges.push({anchor:cur.from(),head:cur.to()});ranges.length&&this.setSelections(ranges,0)}))})),function(dialog){"object"==typeof exports&&"object"==typeof module?dialog(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],mod):dialog(CodeMirror)}((function(CodeMirror){function dialogDiv(cm,template,bottom){var wrap=cm.getWrapperElement(),dialog;return(dialog=wrap.appendChild(document.createElement("div"))).className=bottom?"CodeMirror-dialog CodeMirror-dialog-bottom":"CodeMirror-dialog CodeMirror-dialog-top","string"==typeof template?dialog.innerHTML=template:dialog.appendChild(template),CodeMirror.addClass(wrap,"dialog-opened"),dialog}function closeNotification(cm,newVal){cm.state.currentNotificationClose&&cm.state.currentNotificationClose(),cm.state.currentNotificationClose=newVal}CodeMirror.defineExtension("openDialog",(function(template,callback,options){options||(options={}),closeNotification(this,null);var dialog=dialogDiv(this,template,options.bottom),closed=!1,me=this;function close(newVal){if("string"==typeof newVal)inp.value=newVal;else{if(closed)return;closed=!0,CodeMirror.rmClass(dialog.parentNode,"dialog-opened"),dialog.parentNode.removeChild(dialog),me.focus(),options.onClose&&options.onClose(dialog)}}var inp=dialog.getElementsByTagName("input")[0],button;return inp?(inp.focus(),options.value&&(inp.value=options.value,!1!==options.selectValueOnOpen&&inp.select()),options.onInput&&CodeMirror.on(inp,"input",(function(e){options.onInput(e,inp.value,close)})),options.onKeyUp&&CodeMirror.on(inp,"keyup",(function(e){options.onKeyUp(e,inp.value,close)})),CodeMirror.on(inp,"keydown",(function(e){options&&options.onKeyDown&&options.onKeyDown(e,inp.value,close)||((27==e.keyCode||!1!==options.closeOnEnter&&13==e.keyCode)&&(inp.blur(),CodeMirror.e_stop(e),close()),13==e.keyCode&&callback(inp.value,e))})),!1!==options.closeOnBlur&&CodeMirror.on(dialog,"focusout",(function(evt){null!==evt.relatedTarget&&close()}))):(button=dialog.getElementsByTagName("button")[0])&&(CodeMirror.on(button,"click",(function(){close(),me.focus()})),!1!==options.closeOnBlur&&CodeMirror.on(button,"blur",close),button.focus()),close})),CodeMirror.defineExtension("openConfirm",(function(template,callbacks,options){closeNotification(this,null);var dialog=dialogDiv(this,template,options&&options.bottom),buttons=dialog.getElementsByTagName("button"),closed=!1,me=this,blurring=1;function close(){closed||(closed=!0,CodeMirror.rmClass(dialog.parentNode,"dialog-opened"),dialog.parentNode.removeChild(dialog),me.focus())}buttons[0].focus();for(var i=0;i<buttons.length;++i){var b=buttons[i];!function(callback){CodeMirror.on(b,"click",(function(e){CodeMirror.e_preventDefault(e),close(),callback&&callback(me)}))}(callbacks[i]),CodeMirror.on(b,"blur",(function(){--blurring,setTimeout((function(){blurring<=0&&close()}),200)})),CodeMirror.on(b,"focus",(function(){++blurring}))}})),CodeMirror.defineExtension("openNotification",(function(template,options){closeNotification(this,close);var dialog=dialogDiv(this,template,options&&options.bottom),closed=!1,doneTimer,duration=options&&void 0!==options.duration?options.duration:5e3;function close(){closed||(closed=!0,clearTimeout(doneTimer),CodeMirror.rmClass(dialog.parentNode,"dialog-opened"),dialog.parentNode.removeChild(dialog))}return CodeMirror.on(dialog,"click",(function(e){CodeMirror.e_preventDefault(e),close()})),duration&&(doneTimer=setTimeout(close,duration)),close}))}));